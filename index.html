<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>斗六廠 2026 環境巡檢系統</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- SheetJS 用于生成真正的 Excel 檔案 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; text-align: center; }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .remark-input {
            color: #dc2626; /* 缺失備註設為紅色 */
            font-weight: 700;
            text-align: center;
        }
        .calendar-day-btn {
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="bg-blue-50 text-slate-800 pb-28">

    <div id="root" class="max-w-2xl mx-auto px-4 py-8">
        <!-- 內容由 JavaScript 動態渲染 -->
        <div class="flex flex-col items-center justify-center min-h-[60vh]">
            <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
            <div class="animate-pulse text-blue-600 font-bold tracking-widest">雲端資料同步中...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // ==========================================
        // 1. Firebase 金鑰配置 (已啟動雲端連動)
        // ==========================================
        const firebaseConfig = { 
            apiKey: "AIzaSyB7B55RFiPybsczcuu2NeJFtt2aNtL2O1c", 
            authDomain: "douliu-factory-2026.firebaseapp.com", 
            projectId: "douliu-factory-2026", 
            storageBucket: "douliu-factory-2026.appspot.com", 
            messagingSenderId: "782947103842", 
            appId: "1:782947103842:web:9f8e7d6c5b4a3f21" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "douliu-factory-2026";

        // --- 全域狀態 ---
        window.state = {
            view: 'home',
            selectedDate: new Date(), // 動態設定為今天
            currentMonth: new Date().getMonth(), 
            user: null,
            inspectionData: {},
            inspectors: {},
            lastSaveTimes: {},
            locations: [], // 雲端讀取後更新
            activeGuide: null,
            showAddSelect: false,
            isExporting: false,
            saveStatus: false,
            exportRange: { 
                start: `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}-01`, 
                end: `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}-31` 
            }
        };

        const guideItems = [
            "01館外週邊", "02櫃台接待", "03營運辦公室", "04商品區", "05會員休息區", "06會務部", "07教練部", "08心肺訓練區",
            "09重訓器械訓練區", "10私人教練訓練區", "11男更衣室(含廁所)", "12女更衣室(含廁所)", "13男更淋浴間", "14女更淋浴間", "15安全設備", "16全館公共空間",
            "17員工休息室", "18工務室", "19工務倉庫機房", "20員工", "21*智能販售區", "22*專業拳擊訓練區", "23*女性訓練區", "24*PU跑道",
            "25*道館", "26*攀岩區", "27*飛輪教室", "28*有氧教室", "29*壁球室", "30*桌球室", "31*籃球場", "32*撞球室",
            "33*電動遊戲區", "34*兒童館", "35*游泳池", "36*男三溫暖", "37*女三溫暖", "38*男蒸氣烤箱", "39*女蒸氣烤箱", "40*男公共廁所",
            "41*女公共廁所", "42*殘障公共廁所", "43*公共置物櫃", "44*人體工房"
        ];

        // 預設清單 (首次使用時顯示前 20 項)
        state.locations = guideItems.slice(0, 20);

        // --- 工具函式 ---
        const getDateKey = (date) => {
            const d = new Date(date);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        };
        const splitArea = (name) => {
            const match = name.match(/^([0-9]+[*]?)(.*)$/);
            return match ? { id: match[1], name: match[2] } : { id: "", name: name };
        };
        const cleanAreaName = (name) => name.replace(/^[0-9]+[*]?/, "");

        window.calculateRate = (dateKey) => {
            const dayData = state.inspectionData[dateKey];
            if (!dayData || state.locations.length === 0) return 0;
            const checkedCount = state.locations.filter(loc => dayData[loc]?.checked).length;
            return Math.round((checkedCount / state.locations.length) * 100);
        };

        function generateCalendarDays(month) {
            const year = 2026;
            const firstDay = new Date(year, month, 1).getDay(); 
            const daysInMonth = new Date(year, month + 1, 0).getDate(); 
            const days = [];
            for (let i = 0; i < firstDay; i++) days.push(null);
            for (let d = 1; d <= daysInMonth; d++) days.push(d);
            return days;
        }

        // --- 核心渲染 ---
        window.render = () => {
            const root = document.getElementById('root');
            const { view, selectedDate, currentMonth, inspectionData, inspectors, lastSaveTimes, locations, activeGuide, showAddSelect, isExporting, exportRange, saveStatus } = state;
            const currentKey = getDateKey(selectedDate);
            const todayKey = getDateKey(new Date());

            let html = `
                <header class="flex justify-between items-center mb-6 px-1">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-lg">
                            <i data-lucide="clipboard-check" class="w-5 h-5"></i>
                        </div>
                        <h1 class="text-2xl font-black text-blue-900 tracking-tighter">環境巡檢</h1>
                    </div>
                    <div class="bg-blue-500 px-3 py-1.5 rounded-xl text-[10px] font-black text-white shadow-lg uppercase tracking-wider">2026 Admin</div>
                </header>
            `;

            if (view === 'home') {
                const rate = calculateRate(todayKey);
                html += `
                    <div class="space-y-4 animate-in text-left">
                        <section class="bg-white p-6 rounded-3xl shadow-lg border border-blue-50 flex justify-between items-center relative overflow-hidden text-blue-900">
                            <div class="absolute -right-2 top-0 opacity-[0.03] text-blue-900"><i data-lucide="wind" class="w-24 h-24"></i></div>
                            <div class="z-10">
                                <p class="text-blue-500 font-bold text-xs uppercase tracking-widest text-left">Today's Goal</p>
                                <p class="text-2xl font-black text-blue-900">${todayKey}</p>
                                <button onclick="setView('details', new Date())" class="mt-4 bg-blue-600 text-white px-8 py-2.5 rounded-2xl font-bold shadow-lg hover:bg-blue-700 transition-all active:scale-95">執行今日巡檢</button>
                            </div>
                            <div class="relative w-20 h-20 z-10 flex items-center justify-center">
                                <svg class="w-20 h-20 transform -rotate-90">
                                    <circle cx="40" cy="40" r="34" stroke="currentColor" strokeWidth="6" fill="transparent" class="text-slate-50" />
                                    <circle cx="40" cy="40" r="34" stroke="currentColor" strokeWidth="6" fill="transparent" stroke-dasharray="213.63" stroke-dashoffset="${213.63 - (213.63 * rate) / 100}" class="transition-all duration-1000 text-blue-500" stroke-linecap="round" />
                                </svg>
                                <span class="absolute text-lg font-black text-blue-900">${rate}%</span>
                            </div>
                        </section>

                        <section class="bg-white rounded-3xl p-4 shadow-xl border border-blue-50">
                            <div class="flex items-center gap-2 mb-3 px-1 text-blue-900">
                                <i data-lucide="info" class="text-blue-600 w-4 h-4"></i>
                                <h3 class="font-black text-blue-900 text-sm">區域指南</h3>
                            </div>
                            <div class="grid grid-cols-3 gap-1.5 text-center">
                                ${guideItems.map(item => `
                                    <button onclick="showGuide('${item}')" class="py-2 px-0.5 rounded-lg border border-blue-50 bg-blue-50/10 hover:bg-blue-50 hover:border-blue-200 transition-all text-center min-h-[44px] flex items-center justify-center active:scale-95">
                                        <span class="text-[11px] font-bold text-blue-800 leading-tight w-full text-center px-0.5">${item}</span>
                                    </button>
                                `).join('')}
                            </div>
                        </section>
                    </div>
                `;
            } else if (view === 'calendar') {
                const months = ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"];
                const calendarDays = generateCalendarDays(currentMonth);
                html += `
                    <div class="flex flex-col items-center animate-in">
                        <div class="bg-white w-full rounded-3xl p-6 shadow-xl border border-blue-100 mb-6 text-blue-900">
                            <div class="flex justify-between items-center mb-6 px-1">
                                <button onclick="changeMonth(-1)" class="p-2 hover:bg-blue-50 rounded-full text-blue-600 active:scale-90 transition-all"><i data-lucide="chevron-left"></i></button>
                                <h3 class="text-xl font-black text-blue-900 tracking-tight">2026年 ${months[currentMonth]}</h3>
                                <button onclick="changeMonth(1)" class="p-2 hover:bg-blue-50 rounded-full text-blue-600 active:scale-90 transition-all"><i data-lucide="chevron-right"></i></button>
                            </div>
                            <div class="grid grid-cols-7 gap-1 mb-3 text-center text-[10px] font-black text-slate-300 uppercase">
                                <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
                            </div>
                            <div class="grid grid-cols-7 gap-1.5 text-center">
                                ${calendarDays.map((day, i) => {
                                    if (day === null) return `<div class="aspect-square"></div>`;
                                    const dKey = `2026-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                    const rate = calculateRate(dKey);
                                    const isWeekend = (i % 7 === 0 || i % 7 === 6);
                                    const weekendClass = isWeekend ? 'bg-blue-100/60' : 'bg-white';
                                    return `
                                        <button onclick="setView('details', new Date(2026, ${currentMonth}, ${day}))" 
                                                class="calendar-day-btn rounded-xl border border-blue-50 hover:bg-blue-50 transition-all active:scale-90 shadow-sm ${weekendClass}">
                                            <span class="text-xs font-black ${isWeekend ? 'text-blue-700' : 'text-slate-600'}">${day}</span>
                                            ${rate > 0 ? `<div class="w-1.5 h-1.5 rounded-full mt-1 ${rate === 100 ? 'bg-green-400' : 'bg-orange-400'}"></div>` : ''}
                                        </button>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        <button onclick="toggleExport(true)" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-xl text-[10px] font-black shadow-lg flex items-center gap-1.5 transition-all active:scale-95 uppercase tracking-wider">
                            <i data-lucide="file-spreadsheet" class="w-3.5 h-3.5"></i> 匯出巡檢 Excel 報表
                        </button>
                    </div>
                `;
            } else if (view === 'details') {
                const rate = calculateRate(currentKey);
                const saveTime = lastSaveTimes[currentKey] || "";
                html += `
                    <div class="bg-white rounded-3xl shadow-2xl overflow-hidden animate-in pb-20 relative min-h-[600px] border border-blue-100 text-left">
                        ${saveStatus ? '<div class="absolute inset-0 z-[110] bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center font-bold text-blue-600"><div class="w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>同步雲端中...</div>' : ''}
                        
                        <div class="bg-blue-600 p-5 text-white">
                            <div class="flex justify-between items-center mb-5 gap-4">
                                <!-- 上左: 日期 -->
                                <div class="flex items-center gap-2 bg-blue-700/50 px-4 py-2 rounded-xl border border-blue-400/30 flex-1 min-w-[130px] shadow-inner">
                                    <i data-lucide="calendar-check" class="w-4 h-4 text-blue-200 shrink-0"></i>
                                    <span class="text-sm font-bold truncate">${currentKey}</span>
                                </div>
                                <!-- 上右: 巡檢人員 -->
                                <div class="flex items-center gap-1.5 bg-blue-700/50 px-2.5 py-2 rounded-xl border border-blue-400/30 w-[110px] shrink-0 shadow-inner text-white">
                                    <i data-lucide="user" class="w-4 h-4 text-blue-200 shrink-0"></i>
                                    <input type="text" placeholder="姓名" value="${inspectors[currentKey] || ""}" onchange="updateInspector('${currentKey}', this.value)" class="bg-transparent text-[12px] font-bold focus:outline-none w-full placeholder:text-blue-300">
                                </div>
                            </div>
                            <div class="flex justify-between items-end">
                                <!-- 下左: 進度 + 快捷儲存按鈕 -->
                                <div class="flex items-center gap-2">
                                    <div class="bg-white text-blue-600 px-4 py-1.5 rounded-2xl text-xs font-black shadow-lg">進度: ${rate}%</div>
                                    <button onclick="saveData()" class="bg-blue-500 hover:bg-blue-400 text-white p-1.5 rounded-xl shadow-md active:scale-95 transition-all">
                                        <i data-lucide="save" class="w-3.5 h-3.5"></i>
                                    </button>
                                </div>
                                <!-- 下右: 存檔時間 -->
                                <div class="flex items-center gap-1 text-[10px] text-blue-50 font-medium bg-blue-700/40 px-2.5 py-1.5 rounded-lg border border-blue-400/20">
                                    <i data-lucide="clock" class="w-2.5 h-2.5"></i> ${saveTime ? saveTime : '尚未存檔'}
                                </div>
                            </div>
                        </div>

                        <div class="overflow-x-auto no-scrollbar">
                            <table class="w-full table-fixed border-collapse">
                                <thead class="bg-blue-50 text-blue-900 uppercase font-black tracking-tighter border-b border-blue-100">
                                    <tr>
                                        <th class="px-1 py-4 text-center w-12 text-[13px]">狀態</th>
                                        <th class="px-2 py-4 w-[25%] text-center border-r border-blue-100 text-[13px]">區域</th>
                                        <th class="px-3 py-4 text-[13px] text-center">備註 (缺失填寫)</th>
                                        <th class="w-8"></th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-blue-50 text-slate-800">
                                    ${locations.map(loc => {
                                        const data = inspectionData[currentKey]?.[loc] || { checked: false, remark: "" };
                                        const area = splitArea(loc);
                                        return `
                                            <tr class="hover:bg-blue-50/30">
                                                <td class="py-5 text-center">
                                                    <button onclick="toggleCheck('${loc}')" class="${data.checked ? 'text-green-500' : 'text-slate-200'} transition-all active:scale-75">
                                                        ${data.checked ? '<i data-lucide="check-circle" class="w-[30px] h-[30px] mx-auto"></i>' : '<i data-lucide="circle" class="w-[30px] h-[30px] mx-auto"></i>'}
                                                    </button>
                                                </td>
                                                <td class="border-r border-blue-50 text-center px-1">
                                                    <button onclick="showGuide('${loc}')" class="inline-flex items-center gap-0.5 font-black text-slate-800 text-[12px] leading-tight justify-center w-full">
                                                        ${area.name} <i data-lucide="info" class="w-2.5 h-2.5 text-blue-200"></i>
                                                    </button>
                                                </td>
                                                <td class="px-2 text-center">
                                                    <input type="text" value="${data.remark || ""}" onblur="updateRemark('${loc}', this.value)" class="remark-input w-full bg-transparent border-b border-blue-100 focus:border-blue-400 focus:outline-none py-1 text-[13px]">
                                                </td>
                                                <td class="text-center">
                                                    <button onclick="removeLocation('${loc}')" class="text-slate-100 hover:text-red-400 p-1"><i data-lucide="trash-2" class="w-4 h-4 mx-auto"></i></button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>

                        <div class="p-4 space-y-4">
                            ${!showAddSelect ? `
                                <button onclick="toggleAdd(true)" class="w-full py-2 border-2 border-dashed border-blue-200 text-blue-300 rounded-xl text-[11px] font-bold">+ 新增巡檢區域</button>
                            ` : `
                                <div class="flex gap-2 p-3 bg-blue-50 rounded-xl border border-blue-100 animate-in text-blue-900">
                                    <select id="newLocSelect" class="flex-1 bg-white border border-blue-100 rounded-lg px-2 text-[12px] font-bold outline-none">
                                        ${guideItems.map(item => `<option value="${item}">${item}</option>`).join('')}
                                    </select>
                                    <button onclick="addLocation()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-md">加入</button>
                                    <button onclick="toggleAdd(false)" class="p-2 text-slate-400"><i data-lucide="x" class="w-4 h-4"></i></button>
                                </div>
                            `}
                            <button onclick="saveData()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black shadow-xl active:scale-95 transition-all flex items-center justify-center gap-2 text-lg uppercase tracking-widest">
                                <i data-lucide="save" class="w-5 h-5"></i> 存檔
                            </button>
                        </div>
                    </div>
                `;
            }

            // --- 底部導覽列 ---
            html += `
                <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 w-auto min-w-[160px] bg-white/95 backdrop-blur-xl border border-white rounded-[2rem] shadow-2xl p-1.5 flex justify-around items-center z-50">
                    <button onclick="setView('home')" class="flex-1 flex flex-col items-center gap-0.5 px-4 py-1.5 rounded-2xl transition-all ${view === 'home' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400'}">
                        <i data-lucide="home" class="w-4 h-4"></i><span class="text-[10px] font-black">首頁</span>
                    </button>
                    <div class="w-px h-6 bg-slate-100 mx-1"></div>
                    <button onclick="setView('calendar')" class="flex-1 flex flex-col items-center gap-0.5 px-4 py-1.5 rounded-2xl transition-all ${view === 'calendar' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400'}">
                        <i data-lucide="layout-grid" class="w-4 h-4"></i><span class="text-[10px] font-black">日曆</span>
                    </button>
                </nav>
            `;

            root.innerHTML = html;
            lucide.createIcons();
        }

        // --- 核心邏輯：Excel 報表 ---
        window.handleExport = () => {
            const wb = XLSX.utils.book_new();
            const start = new Date(state.exportRange.start);
            const end = new Date(state.exportRange.end);
            const monthsMap = {};
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const monthName = `${d.getFullYear()}年${d.getMonth() + 1}月`;
                if (!monthsMap[monthName]) monthsMap[monthName] = [];
                monthsMap[monthName].push(new Date(d));
            }
            Object.entries(monthsMap).forEach(([sheetName, days]) => {
                const aoa = [["斗六廠巡檢表", ""]];
                days.forEach(day => aoa[0].push(`${day.getDate()}號`, state.inspectors[getDateKey(day)] || ""));
                aoa.push([]);
                const row3 = ["區域編號", "區域名稱"];
                days.forEach(() => row3.push("狀態", "備註"));
                aoa.push(row3);
                state.locations.forEach(loc => {
                    const area = splitArea(loc);
                    const rowData = [area.id, area.name];
                    days.forEach(day => {
                        const k = getDateKey(day);
                        const rec = state.inspectionData[k]?.[loc] || { checked: false, remark: "" };
                        rowData.push(rec.checked ? "V" : "", rec.remark || "");
                    });
                    aoa.push(rowData);
                });
                XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(aoa), sheetName);
            });
            XLSX.writeFile(wb, `斗六廠巡檢報表_${state.exportRange.start}_至_${state.exportRange.end}.xlsx`);
            window.toggleExport(false);
        };

        // --- 互動功能 ---
        window.setView = (v, d) => { state.view = v; if (d) { state.selectedDate = d; state.currentMonth = d.getMonth(); } render(); };
        window.changeMonth = (delta) => { let next = state.currentMonth + delta; if (next < 0) next = 11; if (next > 11) next = 0; state.currentMonth = next; render(); };
        window.toggleCheck = (loc) => { const k = getDateKey(state.selectedDate); if (!state.inspectionData[k]) state.inspectionData[k] = {}; if (!state.inspectionData[k][loc]) state.inspectionData[k][loc] = { checked: false, remark: "" }; state.inspectionData[k][loc].checked = !state.inspectionData[k][loc].checked; render(); };
        window.updateRemark = (loc, val) => { const k = getDateKey(state.selectedDate); if (!state.inspectionData[k]) state.inspectionData[k] = {}; if (!state.inspectionData[k][loc]) state.inspectionData[k][loc] = { checked: false, remark: "" }; state.inspectionData[k][loc].remark = val; };
        window.updateInspector = (k, name) => { state.inspectors[k] = name; };
        window.showGuide = (item) => { state.activeGuide = item; render(); };
        window.toggleAdd = (show) => { state.showAddSelect = show; render(); };
        window.toggleExport = (show) => { state.isExporting = show; render(); };
        window.updateExportRange = (type, val) => { state.exportRange[type] = val; };

        window.addLocation = () => {
            const select = document.getElementById('newLocSelect');
            const val = select.value;
            if (!state.locations.includes(val)) { 
                state.locations.push(val); 
                state.locations.sort((a, b) => parseInt(a.match(/\d+/) || 999) - parseInt(b.match(/\d+/) || 999));
            }
            state.showAddSelect = false;
            render();
        };

        window.removeLocation = (loc) => { state.locations = state.locations.filter(l => l !== loc); render(); };
        
        // --- 雲端存檔邏輯 (解決卡死問題) ---
        window.saveData = async () => {
            state.saveStatus = true; render();
            const now = new Date();
            const timeStr = `${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            const key = getDateKey(state.selectedDate);

            try {
                // 1. 同步當日紀錄
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'inspections', key);
                await setDoc(docRef, {
                    records: state.inspectionData[key] || {},
                    inspector: state.inspectors[key] || "",
                    saveTime: timeStr,
                }, { merge: true });

                // 2. 同步全域清單 (跨裝置一致)
                const configRef = doc(db, 'artifacts', appId, 'public', 'data', 'config', 'global');
                await setDoc(configRef, { activeLocations: state.locations }, { merge: true });

                state.lastSaveTimes[key] = timeStr;
            } catch (e) {
                console.error("雲端存檔失敗:", e);
                state.lastSaveTimes[key] = timeStr + " (本地)";
            } finally {
                // 強制延遲確保動畫感，然後關閉狀態
                setTimeout(() => {
                    state.saveStatus = false;
                    window.setView('home');
                }, 1000);
            }
        };

        // --- 初始化 & 跨裝置讀取 ---
        const initApp = async () => {
            try {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, async (user) => {
                    state.user = user;
                    if (user) {
                        // 1. 先抓全域配置 (確保巡檢區域清單與電腦同步)
                        const configRef = doc(db, 'artifacts', appId, 'public', 'data', 'config', 'global');
                        const configSnap = await getDoc(configRef);
                        if (configSnap.exists() && configSnap.data().activeLocations) {
                            state.locations = configSnap.data().activeLocations;
                        }

                        // 2. 監聽所有巡檢數據
                        const dataRef = collection(db, 'artifacts', appId, 'public', 'data', 'inspections');
                        onSnapshot(dataRef, (snapshot) => {
                            snapshot.forEach(doc => {
                                const d = doc.data();
                                state.inspectionData[doc.id] = d.records || {};
                                state.inspectors[doc.id] = d.inspector || "";
                                state.lastSaveTimes[doc.id] = d.saveTime || "";
                            });
                            render();
                        });
                    }
                });
            } catch (e) {
                console.warn("Firebase Init Error:", e);
                render();
            }
        };

        initApp(); 
    </script>
</body>
</html>
